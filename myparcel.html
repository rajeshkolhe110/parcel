<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Parcel Label Generator</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    body { font-family: 'Arial', sans-serif; background: #eef1f5; padding: 20px; margin: 0; }
    .container { max-width: 900px; margin: auto; background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
    label { font-weight: bold; display: block; margin-top: 15px; }
    textarea, select, input { width: 100%; padding: 10px; margin-top: 5px; margin-bottom: 15px; border-radius: 6px; font-size: 14px; }
    .buttons { text-align: center; margin-top: 20px; }
    button { background: #007bff; color: white; padding: 10px 25px; border: none; border-radius: 8px; font-size: 16px; margin: 0 10px; cursor: pointer; }
    .preview-container { margin-top: 30px; display: flex; justify-content: center; }
    .label-page { background: white; box-shadow: 0 0 5px rgba(0,0,0,0.2); width: 210mm; height: 297mm; display: flex; align-items: flex-start; justify-content: center; }
    .label-content { max-width: 600px; padding: 20mm; text-align: left; visibility: visible; }
    .label-content h3 { margin: 0 0 4px 0; font-weight: bold; }
    .label-content p { margin: 0; white-space: pre-wrap; }
  </style>
</head>
<body>
<div class="container">
  <h2>Parcel Label Generator</h2>

  <label>Saved Addresses:</label>
  <select id="savedAddresses" onchange="loadSelectedAddress()">
    <option value="">-- Select Saved Address --</option>
  </select>

  <label>To:</label>
  <textarea id="toText" placeholder="Enter recipient address..."></textarea>

  <label>From:</label>
  <textarea id="fromText">AutoMekz Electronics,
Flat No.2 Ram Heights, Laxmi Nagar,
Mahale Farm, Cidco, Nashik,
Maharashtra
Pincode:- 422009
Contact:- 9503298303/9765300065</textarea>

  <div class="buttons">
    <button onclick="saveAndPrint()">Print</button>
    <button onclick="saveAndDownloadPDF()">Save as PDF</button>
  </div>
</div>

<div class="preview-container">
  <div class="label-page" id="labelPreview">
    <div class="label-content" id="labelContent">
      <div><h3>To,</h3><p id="previewTo"></p></div>
      <div style="height:10mm;"></div>
      <div><h3>From,</h3><p id="previewFrom"></p></div>
    </div>
  </div>
</div>

<script>
  const GIST_ID = '9ec248dabac872195a6702a03778cfde'; // Replace this
  const GITHUB_TOKEN = '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'; // Replace this
  const API_URL = `https://api.github.com/gists/9ec248dabac872195a6702a03778cfde`;

  async function loadAddresses() {
    try {
      const res = await fetch(API_URL, {
        headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
      });
      const data = await res.json();
      const content = data.files['parcel-addresses.json'].content;
      const parsed = JSON.parse(content);
      populateDropdown(parsed.addresses || []);
    } catch (err) {
      console.error("Failed to load addresses:", err);
    }
  }

  function populateDropdown(addresses) {
    const dropdown = document.getElementById('savedAddresses');
    dropdown.innerHTML = `<option value="">-- Select Saved Address --</option>`;
    addresses.forEach(addr => {
      const opt = document.createElement('option');
      opt.value = addr;
      opt.textContent = addr.split('\n')[0];
      dropdown.appendChild(opt);
    });
  }

  function loadSelectedAddress() {
    const val = document.getElementById('savedAddresses').value;
    if (val) document.getElementById('toText').value = val;
    updatePreview();
  }

  function updatePreview() {
    document.getElementById("previewTo").innerHTML = document.getElementById("toText").value.replace(/\n/g, "<br>");
    document.getElementById("previewFrom").innerHTML = document.getElementById("fromText").value.replace(/\n/g, "<br>");
  }

  async function saveAddressIfNew() {
    const newAddr = document.getElementById("toText").value.trim();
    if (!newAddr) return;
    try {
      const res = await fetch(API_URL, {
        headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
      });
      const data = await res.json();
      const file = data.files['parcel-addresses.json'];
      const addresses = JSON.parse(file.content).addresses || [];
      if (!addresses.includes(newAddr)) {
        addresses.push(newAddr);
        await fetch(API_URL, {
          method: "PATCH",
          headers: {
            'Authorization': `token ${GITHUB_TOKEN}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            files: {
              'parcel-addresses.json': {
                content: JSON.stringify({ addresses }, null, 2)
              }
            }
          })
        });
      }
    } catch (err) {
      console.error("Failed to save address:", err);
    }
  }

  async function saveAndPrint() {
    await saveAddressIfNew();
    updatePreview();
    const printWindow = window.open('', '', 'width=800,height=1000');
    printWindow.document.write(`<html><head><title>Print</title></head><body>${document.getElementById("labelPreview").innerHTML}</body></html>`);
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
  }

  async function saveAndDownloadPDF() {
    await saveAddressIfNew();
    updatePreview();
    const toLines = document.getElementById("toText").value.trim().split('\n');
    const filename = `Parcel_${(toLines[0] || 'Label').split(' ')[0]}.pdf`;
    html2pdf().set({
      margin: 0,
      filename: filename,
      html2canvas: { scale: 2 },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    }).from(document.getElementById("labelPreview")).save();
  }

  window.onload = () => {
    updatePreview();
    loadAddresses();
  };
</script>
</body>
</html>
